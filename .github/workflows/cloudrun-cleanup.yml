# Cloud Run Scheduled Cleanup
#
# Daily cleanup of orphaned benchmark resources in the dedicated GCP project.
# This is a safety net to catch resources left behind by failed/interrupted runs.

name: 'Cloud Run Cleanup'

on:
  schedule:
    # Run daily at 2am UTC
    - cron: '0 2 * * *'

  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (show what would be deleted)'
        required: false
        default: false
        type: boolean
      older_than:
        description: 'Only delete resources older than (e.g., "1h", "24h")'
        required: false
        default: ''
        type: string

# Only allow one cleanup at a time
concurrency:
  group: cloudrun-cleanup
  cancel-in-progress: false

jobs:
  cleanup:
    name: Cleanup Resources
    runs-on: ubuntu-latest
    if: github.repository == 'pmgledhill102/discord-bot-test-suite'

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Authenticate to GCP
        uses: google-github-actions/auth@7c6bc770dae815cd3e89ee6cdf493a5fab2cc093 # v3.0.0
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@aa5489c8933f4cc7a4f7d45035b3b1440c9c10db # v3.0.1

      - name: Run cleanup
        working-directory: tests/cloudrun
        env:
          PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
          REGION: ${{ vars.GCP_REGION }}
        run: |
          ARGS=""

          # Add dry-run flag if specified
          if [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
            ARGS="${ARGS} --dry-run"
          fi

          # Add older-than flag if specified
          if [[ -n "${{ github.event.inputs.older_than }}" ]]; then
            ARGS="${ARGS} --older-than ${{ github.event.inputs.older_than }}"
          fi

          echo "Running cleanup with args: ${ARGS}"
          # shellcheck disable=SC2086
          ./scripts/cleanup.sh ${ARGS}

      - name: Report cleanup results
        if: always()
        run: |
          {
            echo "## Cleanup Results"
            echo ""
            echo "- **Time:** $(date -u)"
            echo "- **Dry Run:** ${{ github.event.inputs.dry_run || 'false' }}"
            echo "- **Older Than:** ${{ github.event.inputs.older_than || 'N/A' }}"
          } >> "${GITHUB_STEP_SUMMARY}"

      - name: Alert on orphaned resources
        if: success()
        run: |
          # Check if any resources were found (indicating a failed run)
          # This could send a Slack/email alert in a production setup
          echo "Cleanup completed successfully"
