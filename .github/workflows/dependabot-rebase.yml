# Dependabot Auto-Rebase Workflow
#
# Automatically rebases Dependabot PRs that fall behind main.
# Runs every 6 hours to keep PRs up-to-date for auto-merge.

name: Dependabot Auto-Rebase

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch: # Allow manual trigger

permissions:
  pull-requests: write

jobs:
  rebase:
    runs-on: ubuntu-latest
    steps:
      - name: Rebase Dependabot PRs behind main
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;

            // Get all open Dependabot PRs
            const { data: pulls } = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
            });

            const dependabotPRs = pulls.filter(
              pr => pr.user.login === 'dependabot[bot]'
            );

            console.log(`Found ${dependabotPRs.length} open Dependabot PRs`);

            for (const pr of dependabotPRs) {
              // Check if PR is behind main
              const { data: comparison } = await github.rest.repos.compareCommits({
                owner,
                repo,
                base: pr.head.sha,
                head: pr.base.ref,
              });

              if (comparison.behind_by > 0) {
                console.log(`PR #${pr.number} is ${comparison.behind_by} commits behind, requesting rebase...`);

                // Check if we already commented recently (within last 6 hours)
                const { data: comments } = await github.rest.issues.listComments({
                  owner,
                  repo,
                  issue_number: pr.number,
                  per_page: 10,
                });

                const sixHoursAgo = new Date(Date.now() - 6 * 60 * 60 * 1000);
                const recentRebaseComment = comments.find(
                  c => c.body.includes('@dependabot rebase') &&
                       new Date(c.created_at) > sixHoursAgo
                );

                if (recentRebaseComment) {
                  console.log(`  Skipping - already requested rebase recently`);
                  continue;
                }

                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: pr.number,
                  body: '@dependabot rebase',
                });

                console.log(`  Rebase requested for PR #${pr.number}`);
              } else {
                console.log(`PR #${pr.number} is up to date`);
              }
            }
