# Main Lint Workflow
#
# Runs generic linting checks that apply across the entire repository.
# Language-specific linting is handled in per-service workflows.

name: Lint

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  actionlint:
    name: Lint GitHub Actions
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Run actionlint
        uses: raven-actions/actionlint@963d4779ef039e217e5d0e6fd73ce9ab7764e493 # v2.1.0
        with:
          fail-on-error: true

  markdown:
    name: Lint Markdown
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Run markdownlint
        uses: DavidAnson/markdownlint-cli2-action@05f32210e84442804257b2a6f20b273450ec8265 # v19.1.0
        with:
          globs: |
            **/*.md
            !.beads/**

  prettier:
    name: Check Formatting (Prettier)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Set up Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '20'

      - name: Install Prettier
        run: npm install -g prettier

      - name: Check formatting
        run: prettier --check "**/*.{json,yml,yaml}" --ignore-path .prettierignore

  yaml-lint:
    name: Lint YAML
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Run yamllint
        uses: ibiqlik/action-yamllint@2576378a8e339169678f9939646ee3ee325e845c # v3.1.1
        with:
          file_or_dir: .
          config_data: |
            extends: default
            rules:
              line-length:
                max: 160
              truthy:
                check-keys: false
              document-start: disable
            ignore: |
              .beads/
              node_modules/
              vendor/

  cspell:
    name: Spell Check Markdown
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Run cspell
        uses: streetsidesoftware/cspell-action@24fa8d3096a314ce263f39578744e9d9f8d80acf # v8.1.2
        with:
          files: '**/*.md'

  terraform:
    name: Lint Terraform
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3

      - name: Check formatting
        working-directory: tests/cloudrun/terraform
        run: terraform fmt -check -recursive

      - name: Initialize Terraform
        working-directory: tests/cloudrun/terraform
        run: terraform init -backend=false

      - name: Validate Terraform
        working-directory: tests/cloudrun/terraform
        run: terraform validate

  # Gatekeeper job that always runs - use this as the single required check
  # in branch protection instead of individual lint jobs
  lint-complete:
    name: Lint Complete
    runs-on: ubuntu-latest
    if: always()
    needs: [actionlint, markdown, prettier, yaml-lint, cspell, terraform]
    steps:
      - name: Check lint results
        run: |
          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" ]]; then
            echo "One or more lint jobs failed"
            exit 1
          fi
          if [[ "${{ contains(needs.*.result, 'cancelled') }}" == "true" ]]; then
            echo "One or more lint jobs were cancelled"
            exit 1
          fi
          echo "All lint jobs passed or were skipped"
