# PR Auto-Update Workflow
#
# Automatically updates PR branches that fall behind main.
# Runs hourly and updates ONE branch per run to avoid race conditions.
# Works with any PR that has auto-merge enabled (not just Dependabot).

name: PR Auto-Update

on:
  schedule:
    - cron: '0 * * * *' # Every hour
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  update-branch:
    runs-on: ubuntu-latest
    steps:
      - name: Update one PR branch behind main
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000);

            // Get all open PRs targeting main
            const { data: pulls } = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
              base: 'main',
              sort: 'created',
              direction: 'asc',  // Oldest first for fairness
            });

            console.log(`Found ${pulls.length} open PRs targeting main`);

            // Filter to PRs with auto-merge enabled
            const autoMergePRs = pulls.filter(pr => pr.auto_merge !== null);
            console.log(`${autoMergePRs.length} have auto-merge enabled`);

            for (const pr of autoMergePRs) {
              // Check if PR is behind main
              const { data: comparison } = await github.rest.repos.compareCommits({
                owner,
                repo,
                base: pr.head.sha,
                head: 'main',
              });

              if (comparison.behind_by === 0) {
                console.log(`PR #${pr.number}: up to date`);
                continue;
              }

              console.log(`PR #${pr.number}: ${comparison.behind_by} commits behind main`);

              // Skip if branch was updated recently (avoid update loops)
              const lastUpdated = new Date(pr.updated_at);
              if (lastUpdated > oneHourAgo) {
                console.log(`  Skipping - updated recently at ${pr.updated_at}`);
                continue;
              }

              // Update this branch and exit (one at a time)
              console.log(`  Updating branch...`);
              try {
                await github.rest.pulls.updateBranch({
                  owner,
                  repo,
                  pull_number: pr.number,
                });
                console.log(`  Successfully updated PR #${pr.number}`);
              } catch (error) {
                console.log(`  Failed to update: ${error.message}`);
                // Continue to try next PR if this one fails
                continue;
              }

              // Exit after updating one PR
              console.log('Exiting - will process next PR in next run');
              return;
            }

            console.log('No PRs need updating');
